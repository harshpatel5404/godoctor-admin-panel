<!DOCTYPE html>
<html lang="en">
  
<head>
    <%- include('./partials/head'); -%>
    
    <style>
      .hand-hover {
        cursor: pointer;
      }
    </style>
</head>
<body onload="startTime()">
    <%- include('./partials/header_sidebar'); -%>
    
    <!-- tap on top starts-->

        <!-- Page Sidebar Ends-->
        <div class="page-body">
          <div class="container-fluid">
            <div class="page-title">
              <div class="row">
                <div class="col-sm-6">
                  <h3><%=lan.Chat%></h3>
                </div>
                <div class="col-sm-6">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/index"><i data-feather="home"></i></a></li>
                    <li class="breadcrumb-item"><%=lan.Dashboard%></li>
                    <li class="breadcrumb-item active"><%=lan.Chat%></li>
                  </ol>
                </div>
              </div>
            </div>
          </div>
          <!-- Container-fluid starts-->
          <div class="container-fluid">
            <div class="row">
              <div class="col-3 call-chat-sidebar">
                <div class="card">
                  <div class="card-body chat-body">
                    <div class="chat-box">
                      <div class="chat-left-aside">
                        <div class="d-flex mb-0">
                          <div class="flex-grow-1 mt-2 mb-2">
                            <div class="position-relative">
                              <input type="text" class="form-control w-100 ps-3 pe-5 rounded-3" placeholder="<%=lan.Search%>" id="chatSearchInput">
                              <i class="fa fa-search position-absolute top-50 end-0 translate-middle-y me-3 text-muted"></i>
                            </div>
                            <!-- <input class="form-control" type="text" name="name" placeholder="<%=lan.Search%>" required> -->
                          </div>
                        </div>
                        <!-- <a class="f-w-600"></a> -->
                        <% if(chat_list != ""){ %>
                        <div class="people-list custom-scrollbar" id="people-list" style="overflow-y: auto;">
                          <div class="list custom-scrollbar" id="chat_user_list">
                            
                              <% chat_list.forEach((data, i) => { %>

                                <% first = data.name.charAt(0) %>
                                <div class="d-flex align-items-center rounded-3 my-1 p-1 <%= i == 0 ? 'chat_background' : '' %>  chat_div hand-hover cl<%= auth.admin_id == data.sender_id ? data.receiver_id : data.sender_id %>" 
                                  id="chat_user" data-sender="<%=data.sender_id%>" data-reciver="<%=data.receiver_id%>" data-name="<%= data.name.toLowerCase() %>">
                                  
                                  <div class="m-r-10 p-2 d-flex align-items-center">
                                    <% if (data.image != '') { %>
                                      <img class="rounded-circle" height="50" width="50" src="../../<%=data.image%>" alt=""  onerror="this.src='../../images/profile.png'">
                                    <% } else { %>
                                      <img class="rounded-circle" height="50" width="50" src="../../images/profile.png" alt="">
                                    <% } %>
                                  </div>

                                  <div>
                                    <h5 class="name mb-1 d-flex">
                                      <%=data.name%>
                                      <span class="dot1 <%= data.status != '1' || i == 0 ? 'd-none' : '' %>" id="new_message" style="margin-left: 5px;"></span>
                                      
                                      <span class="loadingDots d-none" id="user_list_typing"><span class="dot1 m-0"></span><span class="dot2 m-0"></span><span class="dot3 m-0"></span><span class="dot4 m-0"></span></span> 
                                    </h5>
                                    <p class="status f-w-700 m-0"><%-data.message%> <span class="f-w-400"><%=data.date%></span></p>
                                  </div>
                                </div>

                              <% }) %>

                                </div>
                                <input type="hidden" id="chat_u_id" value="<%=auth.admin_id%>">
                              </div>

                            <% } else { %>

                              <div class="people-list custom-scrollbar d-flex align-items-center justify-content-center" id="people-list">
                                <div class="list custom-scrollbar" id="chat_user_list">
                                  <div class="text-center">
                                    <i class="fa fa-comments-o f-40"></i>
                                  </div>
                                  <div>
                                    <span class="f-18 f-w-500"><%=lan.Chat%> <%=lan.Unavailable%></span>
                                  </div>
                                </div>
                              </div>
                              
                            <% }; %>
                              
                      </div>
                    </div>
                  </div>
                </div>
              </div>



              <% if(one_chat_list.all_chat != "") { %>
              <div class="col-sm-12 col-md-9 col-lg-9 col-xl-9 call-chat-body">
                <div class="card">
                  <div class="card-body p-0">
                    <div class="row chat-box">
                      <div class="col chat-right-aside">
                        <div class="chat">
                          <div class="d-flex chat-header clearfix align-items-start">
                            <div class="flex-grow-1">
                              <div class="about m-0">
                                <% if ( user != "" ){ %>
                                    <div class="name d-flex align-item-center">
                                      <p class="f-w-600 f-16 m-0" id="chat_profile_user"><%=user.name%></p>
                                    </div>
                                <% } else { %>
                                  <div class="name"><a href="user-profile.html" id="chat_profile_user"></a></div>
                                <% }; %>
                                
                                <% if ( one_chat_list.all_chat != "" ){ %>
                                <div class="status digits" id="chat_profile_time"><%=lan.Last%> <%=lan.Message%> <%= one_chat_list.all_chat.at(-1).chat.at(-1).date%></div>
                                <% } else { %>
                                  <div class="status digits" id=""></div>
                                <% }; %>
                              </div>
                            </div>
                          </div>

                          <div class="chat-history chat-msg-box custom-scrollbar pb-0 chat_message_position" id="scrollbottom">
                            <ul id="chat_detail">
                              <% one_chat_list.all_chat.forEach((adata, i) => { %>
                                
                                <li class="text-center my-2">
                                  <span class="f-w-500"><%=adata.date%></span>
                                </li>

                                <% adata.chat.forEach((cdata, i) => { %>

                                  <% if (cdata.status == 1){ %>
                                      <li class="clearfix">
                                        <div class="message other-message pull-right py-1 mb-1 chat_background costycls">
                                          <div class="message-data m-0"><span class="message-data-time"><%=cdata.date%></span></div><%- cdata.message.replace(/\n/g, '<br>') %>
                                        </div>
                                      </li>
                                  <% } else { %>
                                      <li>
                                        <div class="message my-message py-1 mb-1 costycls">
                                          <div class="message-data text-end m-0"><span class="message-data-time"><%=cdata.date%></span></div><%- cdata.message.replace(/\n/g, '<br>') %>
                                        </div>
                                      </li>
                                  <% }; %>

                                <% }) %>
                              <% }) %>
                              
                            </ul>
                            <div class="m-l-15 d-none" id="user_typing">
                              <span class="loadingmessage m-0"><span class="mdot1 m-0"></span><span class="mdot2 m-0"></span><span class="mdot3 m-0"></span></span>
                            </div>
                          </div>
                          
                          <div class="chat-message clearfix">
                            <div class="row">
                              <input type="hidden" id="senderu_id" value="<%=send_id%>">
                              <input type="hidden" id="lmcdcd" value="<%= one_chat_list.all_chat.at(-1).date %>">
                              <div class="col-xl-12 d-flex">
                                <div class="input-group text-box">
                                  <textarea class="form-control input-txt-bx" id="chat_input" name="message-to-send" rows="1" placeholder="<%=lan.Type_a_message%>......"
                                  style="border-radius: 8px 0% 0% 8px !important; resize: none;" data-last="<%=lan.Last%>" data-message="<%=lan.Message%>"></textarea>

                                  <!-- <input class="form-control input-txt-bx " style="border-radius: 8px 0% 0% 8px !important;" id="chat_input" type="text" name="message-to-send" placeholder="<%=lan.Type_a_message%>......"> -->
                                  <button class="btn btn-primary chat_btn" style="border-radius: 0% 8px 8px 0%" id="chat_send_btn" type="button"><%=lan.SEND%></button>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col chat-menu">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <% }; %>



            </div>
          </div>
          <!-- Container-fluid Ends-->
        </div>

        <%- include('./partials/footer'); -%>
        <%- include('./partials/script'); -%>
        <script src="../socket.io/socket.io.js"></script>
        <script src="../../web_socket.js"></script>

        <!-- <script>
          const socket = io();



        </script> -->

      <script>
        // JavaScript to scroll to the bottom of the chat window
        let chatDetail = document.getElementById('scrollbottom');
        chatDetail.scrollTop = chatDetail.scrollHeight;
      </script>
  </body>
</html>